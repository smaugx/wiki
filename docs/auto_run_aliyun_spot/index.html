<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="author" content="smaugx">
    <link rel="canonical" href="http://rebootcat.com/wiki/auto_run_aliyun_spot/">
    <link rel="shortcut icon" href="../img/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>auto-run-aliyun-spot - My Wiki</title>
    <link href="../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../css/highlight.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../js/jquery-3.2.1.min.js"></script>
    <script src="../js/bootstrap-3.3.7.min.js"></script>
    <script src="../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "aliyun_spot", url: "#_top", children: [
          ]},
          {title: "\u652f\u6301\u4e00\u4e0b\u4f5c\u8005\uff0c\u8d2d\u4e70\u963f\u91cc\u4e91", url: "#_1", children: [
          ]},
          {title: "\u80cc\u666f", url: "#_2", children: [
          ]},
          {title: "\u811a\u672c\u529f\u80fd", url: "#_3", children: [
              {title: "\u81ea\u52a8\u521b\u5efa\u963f\u91cc\u4e91\u62a2\u5360\u5f0f\u5b9e\u4f8b", url: "#_4" },
              {title: "\u624b\u52a8\u91ca\u653e\u4e00\u4e2a\u6216\u8005\u591a\u4e2a\u5b9e\u4f8b", url: "#_5" },
          ]},
          {title: "\u5982\u4f55\u4f7f\u7528", url: "#_6", children: [
              {title: "1 \u514b\u9686\u4ed3\u5e93", url: "#1" },
              {title: "2  \u8c03\u6574\u914d\u7f6e", url: "#2" },
              {title: "3 \u521b\u5efa\u5b9e\u4f8b", url: "#3" },
              {title: "4 \u5217\u51fa\u5b9e\u4f8b", url: "#4" },
              {title: "5 \u91ca\u653e\u5b9e\u4f8b", url: "#5" },
          ]},
          {title: "\u963f\u91cc\u4e91\u5b98\u7f51\u64cd\u4f5c", url: "#_7", children: [
          ]},
          {title: "\u7136\u540e\u5f00\u59cb\u521b\u5efa\u548c\u7ba1\u7406\u4f60\u7684\u5b9e\u4f8b\u5427\uff01\uff01", url: "#_8", children: [
          ]},
          {title: "\u7136\u540e\u5f00\u59cb\u521b\u5efa\u548c\u7ba1\u7406\u4f60\u7684\u5b9e\u4f8b\u5427\uff01\uff01", url: "#_9", children: [
          ]},
          {title: "\u7136\u540e\u5f00\u59cb\u521b\u5efa\u548c\u7ba1\u7406\u4f60\u7684\u5b9e\u4f8b\u5427\uff01\uff01", url: "#_10", children: [
          ]},
          {title: "\u9644", url: "#_11", children: [
          ]},
        ];

    </script>
    <script src="../js/base.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../scon1/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../scon1/" class="btn btn-xs btn-link">
        scon1
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../scons4/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../scons4/" class="btn btn-xs btn-link">
        Scons4
      </a>
    </div>
    
  </div>

    

    <hr />
<p>title: 自动创建阿里云抢占式实例
date: 2020/08/24 22:23:58
tags: 
    - aliyun
    - spot
    - ecs
    - python
categories:
    - python
comments: </p>
<hr />
<h1 id="aliyun_spot"><a href="https://github.com/smaugx/aliyun_spot">aliyun_spot</a></h1>
<p>自动创建阿里云抢占式实例。</p>
<h1 id="_1"><a href="https://www.aliyun.com/minisite/goods?userCode=c5nuzwoj">支持一下作者，购买阿里云</a></h1>
<h1 id="_2">背景</h1>
<p>阿里云抢占式实例应该属于阿里云的一种闲置资源利用，性价比非常高，每小时的价格在 0.01 ~ 0.05 每小时，具体根据不同的配置和地域有差别，流量价格小于 1元/G.</p>
<p>抢占式实例最高可以以<strong>一折的价格购买 ECS 实例，并能稳定持有该实例至少一个小时</strong>。一个小时后，当市场价格高于您的出价或资源供需关系变化时，<strong>抢占式实例会被自动释放</strong>，请做好数据备份工作。</p>
<p><strong>非常适合爬虫</strong></p>
<p><strong>非常适合爬虫</strong></p>
<p><strong>非常适合爬虫</strong></p>
<p>也适合程序员个人日常开发使用，上班来创建，下班释放，开销基本可以控制在在 1毛 ~ 2 毛。</p>
<p>对于我来说，最近在写一个爬虫，看了很多代理都很贵，免费的又不稳定，正好了解到阿里云的抢占式实例，所以非常满足我的需求。</p>
<p>但是要注意，这个实例是有可能被释放的，但是不用担心，比如<strong>香港地区的释放率最近（2020-08-19）小于 3%. 另外，每个人可以最大创建 100 个实例</strong>，所以还是不用太担心。</p>
<p><img alt="" src="https://cdn.jsdelivr.net/gh/smaugx/MyblogImgHosting_2/rebootcat/auto_run_aliyun_spot/1.png" /></p>
<!-- more -->

<h1 id="_3">脚本功能</h1>
<p>脚本仓库: <a href="https://github.com/smaugx/aliyun_spot">https://github.com/smaugx/aliyun_spot</a></p>
<h2 id="_4">自动创建阿里云抢占式实例</h2>
<p>支持以下一些参数：</p>
<ul>
<li>实例所属地域</li>
<li>创建的实例数量</li>
<li>公网出口带宽最大值</li>
<li>实例付费的策略和每小时最大价格</li>
<li>系统盘大小</li>
<li>释放时间（hours）</li>
<li>实例规格(cpu/mem/localdisk/net/ipv6)</li>
</ul>
<h2 id="_5">手动释放一个或者多个实例</h2>
<p>可以使用脚本提前释放一个或者多个实例。</p>
<p><strong>创建的时候可以设置自动释放时间，当然也支持随时手动释放</strong>。</p>
<h1 id="_6">如何使用</h1>
<pre><code>$ python run_aliyunspot.py
usage: run_aliyunspot.py [-h] [-c [CREATE]] [-r [RELEASE]] [-l [LIST]] [-s [SPOTID [SPOTID ...]]]

aliyunspot, 自动创建阿里云抢占式实例,支持自动/手动释放

optional arguments:
  -h, --help            show this help message and exit
  -c [CREATE], --create [CREATE]
                        create aliyun spot instance and run instance
  -r [RELEASE], --release [RELEASE]
                        release aliyun spot instance
  -l [LIST], --list [LIST]
                        list local record aliyun spot instance
  -s [SPOTID [SPOTID ...]], --spotid [SPOTID [SPOTID ...]]
                        aliyun spot instance_id for release, you can give more than one
</code></pre>

<h2 id="1">1 克隆仓库</h2>
<pre><code>$ git clone https://github.com/smaugx/aliyun_spot.git
$ cd aliyun_spot
$ virtualenv -p python3 vv
$ source vv/bin/activate
$ pip install -r requirements.txt
</code></pre>

<h2 id="2">2  调整配置</h2>
<pre><code>$ cp test_config.py config.py
# 打开配置文件，根据你自己的需求修改里面的配置选项
$ vim config.py
</code></pre>

<p>当然你也可以不用修改其他配置，只需要把你的 <strong>access_id</strong> 和 <strong>access_secret</strong> 填进去就可以，以及 <strong>key_pair_name</strong> 填进去。（见后文章节 <strong>#阿里云官网操作#</strong> ）</p>
<p><strong>默认创建的是香港地区的抢占式实例，内存 500MB, 1 CPU, 系统盘 20GB, 按流量计费（1元/G), 公网出口带宽 10Mbps, 1 小时候自动释放。</strong></p>
<blockquote>
<p>2020-08-19 上述默认配置的实例价格在 ￥ 0.018 /时。</p>
</blockquote>
<p>如果你觉得这个配置(cpu/mem)无法满足你的要求，那么可以调整 <strong>instance_type</strong> 这个参数，表示实例规格，详细可以查看阿里云官网页面 <a href="https://help.aliyun.com/document_detail/25378.html">云服务器 ECS &gt; 实例 &gt; 实例规格族</a></p>
<h2 id="3">3 创建实例</h2>
<pre><code>$ python run_aliyunspot.py -c
will create and run aliyun spot instance, please wait...
Success. Instance creation succeed. InstanceIds: i-j6cfhcbb3o2pepduwgfk
Instance boot successfully: i-j6cfhcbb3o2pepduwgfk
Instances all boot successfully


InstanceId:i-j6cfhcbb3o2pepduwgfk
InstanceName:smaug-000-aliyun-8242148
HostName:smaug-000-aliyun-8242148
PublicIp:47.242.33.179
KeyPairName:aliyunspot
CreationTime:2020-08-24T13:48Z
AutoReleaseTime:2020-08-24T22:48Z


instance info saved in file:./ecs/ecs.i-j6cfhcbb3o2pepduwgfk
now you can use ssh: ssh -i ~/.ssh/aliyunspot.pem root@47.242.33.179
</code></pre>

<p>如上，创建成功。然后接下来就可以使用 ssh 登录：</p>
<pre><code>$ ssh -i ~/.ssh/~/.ssh/aliyunspot.pem root@8.210.245.226
</code></pre>

<h2 id="4">4 列出实例</h2>
<pre><code>$ python run_aliyunspot.py -l
list all local record instance:
['i-j6caz353cisgl3fzenwi', 'i-j6cbyis12fb1fpzk59fv', 'i-j6cfhcbb3o2pepduwgfk']
</code></pre>

<p>注意，上面仅仅是把之前创建并保存的实例信息从文件当中读取出来，并没有与 aliyun 交互。</p>
<h2 id="5">5 释放实例</h2>
<pre><code>$ python run_aliyunspot.py -r -s i-j6caz353cisgl3fzenwi i-j6cbyis12fb1fpzk59fv
will release aliyun spot instance:
['i-j6caz353cisgl3fzenwi', 'i-j6cbyis12fb1fpzk59fv']
please wait...

release instance:[&quot;i-j6caz353cisgl3fzenwi&quot;, &quot;i-j6cbyis12fb1fpzk59fv&quot;] done
</code></pre>

<h1 id="_7"><a href="https://www.aliyun.com/minisite/goods?userCode=c5nuzwoj">阿里云官网操作</a></h1>
<p>上面提到了几个配置是需要在阿里云官网操作的。</p>
<p><strong>阿里云官网的使用还是挺复杂的，因为功能太多了，花费了我至少一个上午的时间才熟悉了整个操作，完成了整个脚本</strong></p>
<p><strong>所以整理了这个脚本方便大家使用，对阿里云的操作只需要下面几个：</strong></p>
<ul>
<li>注册一个阿里云账号，这个不用说了吧</li>
<li>充值 100 元以上，比如 130 元。因为创建实例账号里至少要 100 元</li>
<li>点击 <a href="https://ram.console.aliyun.com/overview">https://ram.console.aliyun.com/overview</a> 创建一个用户组，分配权限 AliyunECSFullAccess 和 AliyunVPCFullAccess</li>
<li>还是上一步的页面，添加 ram 子账号，添加到刚才创建的用户组，这个账号会用来编程访问 aliyun API</li>
<li>还是上一步的页面，为这个ram 子账号创建 AccessKey。<strong>记得保存好</strong>。</li>
<li>在 <a href="https://ecs.console.aliyun.com/">https://ecs.console.aliyun.com/</a> 页面选择 网络与安全-密钥对，创建密钥对 aliyunspot (名字任意），会自动下载这个私钥，<strong>记得保存好，一般要放到 ~/.ssh 目录下，并且记得  <code>chmod 600 aliyunspot.pem</code></strong></li>
</ul>
<p>OK, 到这里基本上得到了我们脚本里需要的几个配置：</p>
<ul>
<li>access_id</li>
<li>access_secret</li>
<li>key_pair_name</li>
</ul>
<p>把上述几个配置填到 config.py 中即可。</p>
<h1 id="_8">然后开始创建和管理你的实例吧！！</h1>
<h1 id="_9">然后开始创建和管理你的实例吧！！</h1>
<h1 id="_10">然后开始创建和管理你的实例吧！！</h1>
<p>Blog:</p>
<ul>
<li>
<p><a href="http://rebootcat.com">rebootcat.com</a></p>
</li>
<li>
<p>email: <a href="&#109;&#97;&#105;&#108;&#116;&#111;&#58;&#108;&#105;&#110;&#117;&#120;&#99;&#111;&#100;&#101;&#50;&#110;&#105;&#107;&#105;&#64;&#103;&#109;&#97;&#105;&#108;&#46;&#99;&#111;&#109;">&#108;&#105;&#110;&#117;&#120;&#99;&#111;&#100;&#101;&#50;&#110;&#105;&#107;&#105;&#64;&#103;&#109;&#97;&#105;&#108;&#46;&#99;&#111;&#109;</a></p>
</li>
</ul>
<p>2020-08-24 于杭州 <br />
<em>By  <a href="https://github.com/smaugx">史矛革</a></em></p>
<h1 id="_11">附</h1>
<ul>
<li><a href="https://www.aliyun.com/minisite/goods?userCode=c5nuzwoj">阿里云官网</a></li>
<li><a href="https://api.aliyun.com">Aliyun OpenAPI Explorer</a></li>
</ul>

  <br>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../scon1/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../scon1/" class="btn btn-xs btn-link">
        scon1
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../scons4/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../scons4/" class="btn btn-xs btn-link">
        Scons4
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="container-fluid wm-page-content">
      <p>
        <a href="https://github.com/smaugx/wiki/edit/master/docs/auto_run_aliyun_spot.md"><i class="fa fa-github"></i>
Edit on GitHub</a>
      </p><p>this is copyright</p>
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="https://github.com/gristlabs/mkdocs-windmill">Windmill</a> theme by Grist Labs.</p>
</footer>

</body>
</html>